<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Crazy Bouncy Balls</title>

<!-- ROBUST LIBRARY LOADING (jsDelivr is faster/stable) -->
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/shaders/CopyShader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/shaders/LuminosityHighPassShader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/EffectComposer.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/RenderPass.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/ShaderPass.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/UnrealBloomPass.js"></script>

<style>
    html, body { height: 100%; width: 100%; overflow: hidden; margin: 0; font-family: Arial, sans-serif; background-color: #f0f0f0; transition: background-color 0.3s ease; }
    body.editor-active .ball { cursor: cell; }
    
    /* --- CANVAS & WORLD --- */
    #world { position: absolute; width: 100%; height: 100%; overflow: hidden; z-index: 10; pointer-events: none; }
    #three-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 5; display: none; }
    
    /* --- BALL STYLES --- */
    .ball { position: absolute; cursor: pointer; z-index: 10; border-radius: 50%; pointer-events: auto; will-change: transform, top, left; }
    .ball-inner { width: 100%; height: 100%; border-radius: 50%; border: solid 5px black; box-sizing: border-box; transition: border-color 0.3s ease, filter 0.3s ease, box-shadow 0.1s ease-out; background-color: #ff0000; }
    
    /* Light Mode */
    body:not(.dark-mode):not(.glow-mode) .ball-inner { filter: brightness(1.1); border-color: black; }
    
    /* Dark Mode */
    body.dark-mode:not(.glow-mode) { background-color: #1a1a1a; }
    body.dark-mode:not(.glow-mode) .ball-inner { filter: brightness(0.9); border-color: black !important; }
    
    /* GLOW MODE (2D) - No Outline, Bright Core */
    body.glow-mode { background-color: #111; }
    body.glow-mode .ball-inner { 
        border: none !important; 
        filter: brightness(1.3) saturate(1.2);
    }

    /* --- UI ELEMENTS --- */
    #fps-counter { position: fixed; top: 60px; left: 10px; color: #00FF00; font-family: monospace; font-size: 12px; background: rgba(0,0,0,0.7); padding: 4px 8px; border-radius: 4px; pointer-events: none; display: none; z-index: 90; border: 1px solid #00FF00; }
    #fps-counter.visible { display: block; }
    
    .menu-box { position: fixed; top: 10px; right: 10px; width: auto; min-width: 260px; padding: 15px; border-radius: 10px; background-color: rgba(0, 0, 0, 0.65); color: #ffffff; user-select: none; font-size: 16px; transition: opacity 0.3s ease, transform 0.3s ease; transform: translateX(0); z-index: 100; display: flex; flex-direction: column; max-height: 90vh; }
    .menu-box.hidden { opacity: 0; transform: translateX(110%); pointer-events: none; }
    
    .menu-header { display: flex; gap: 5px; margin-bottom: 10px; flex-wrap: wrap; }
    .menu-header button { width: 36px; height: 36px; padding: 6px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); border-radius: 50%; color: white; cursor: pointer; display: flex; justify-content: center; align-items: center; }
    .menu-header button:hover { background: rgba(255,255,255,0.2); }
    .menu-header button svg { width: 20px; height: 20px; }
    
    button.active { background: radial-gradient(circle, #4dabf5, #2196F3); border-color: #4dabf5; box-shadow: 0 0 8px #2196F3; }
    button.glow-active { background: radial-gradient(circle, #81c784, #00FF00); border-color: #81c784; box-shadow: 0 0 8px #00FF00; }
    button.red-active { background: radial-gradient(circle, #ef5350, #f44336); border-color: #ef5350; box-shadow: 0 0 8px #f44336; }
    
    .input-container { margin-bottom: 10px; font-size: 14px; }
    .slider-row { display: flex; align-items: center; margin-top: 5px; }
    .slider-row input[type="range"] { flex-grow: 1; margin: 0 5px; }
    .slider-row input[type="number"] { width: 60px; }
    button.action-btn { width: 100%; padding: 10px; margin-top: 5px; border: none; border-radius: 5px; background: #4CAF50; color: white; cursor: pointer; font-size: 14px; }
    button.danger-btn { background: #f44336; }
    button.warning-btn { background: #FFEB3B; color: black; font-weight: bold; }
    
    .editor-tabs { display: flex; margin-bottom: 15px; }
    .tab-btn { flex: 1; padding: 8px; background: rgba(255,255,255,0.1); cursor: pointer; text-align: center; border: 1px solid rgba(255,255,255,0.3); }
    .tab-btn.active { background: #2196F3; }
    
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    .color-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(30px, 1fr)); gap: 5px; margin-bottom: 10px; }
    .color-swatch { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 2px solid white; }
    
    .sounds-menu { margin-top: 10px; }
    .sounds-content { max-height: 0; overflow: hidden; transition: max-height 0.3s; background: rgba(0,0,0,0.2); padding: 0 10px; }
    .sounds-menu.open .sounds-content { max-height: 100px; padding: 10px; }
    
    .trail, .particle, .flash { position: absolute; pointer-events: none; }
    .trail { border-radius: 50%; opacity: 0.6; }
    .particle { border-radius: 50%; z-index: 20; }
    .flash { z-index: 50; border-radius: 50%; background: white; opacity: 0; }
    
    .highlight-box { position: absolute; border: 3px dashed #00FFFF; z-index: 50; pointer-events: none; box-sizing: border-box; border-radius: 50%; }
    #show-menu-hint { position: fixed; top: 10px; right: 10px; background: rgba(0,0,0,0.5); color: white; padding: 5px 15px; border-radius: 20px; font-size: 12px; opacity: 0; pointer-events: none; }
    #show-menu-hint.visible { opacity: 0.5; }
    
    /* Hide DOM elements in 3D mode */
    body.mode-3d .ball, body.mode-3d .trail, body.mode-3d .particle, body.mode-3d .flash { display: none !important; }
</style>
</head>
<body>

<div id="three-container"></div>
<div id="world"></div>
<div id="fps-counter">FPS: 0</div>
<div id="show-menu-hint"></div>

<!-- MENU -->
<div id="side-box" class="menu-box">
    <div class="menu-header">
        <button id="fullscreen-btn" title="Fullscreen"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/></svg></button>
        <button id="threed-btn" title="3D Mode (Off -> Blue -> Red)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg></button>
        <button id="gyro-btn" class="disabled"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="5" width="18" height="14" rx="2"/><line x1="8" y1="12" x2="16" y2="12"/><circle cx="7" cy="12" r="2"/></svg></button>
        <button id="pause-btn"><svg id="pause-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg></button>
        <button id="no-walls-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-dasharray="2 2"><rect x="3" y="3" width="18" height="18" rx="2"/></svg></button>
        <button id="dark-mode-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 21.5A9.5 9.5 0 1 0 12 2.5 9.5 9.5 0 0 0 12 21.5z"/></svg></button>
        <button id="fps-btn">FPS</button>
    </div>
    <button id="add-btn" class="action-btn">Add Ball (A)</button>
    <button id="editor-btn" class="action-btn" style="background:#2196F3">Ball Editor</button>
    <button id="clear-btn" class="action-btn danger-btn">Clear</button>
    <div class="sounds-menu"><button class="sounds-toggle">Sounds â–¼</button><div class="sounds-content"><label><input type="checkbox" id="sound-toggle" checked> Sound</label><br><label><input type="checkbox" id="lemon-sound-toggle" checked> Lemon Sfx</label></div></div>
</div>

<!-- EDITOR -->
<div id="editor-box" class="menu-box hidden">
    <button id="done-btn" class="danger-btn">Done</button>
    <div style="padding-top:30px;" class="editor-box-inner-content">
        <div class="editor-tabs"><div class="tab-btn active" id="tab-global">Global</div><div class="tab-btn" id="tab-single">Single</div></div>
        <div id="editor-content-wrapper">
            <div id="content-global" class="tab-content active">
                <div class="input-container">Size: <span id="val-size"></span> <div class="slider-row"><button class="reset-btn" data-target="tamanho">R</button><input id="in-size" type="range" min="10" max="200" value="100"></div></div>
                <div class="input-container">Gravity: <span id="val-grav"></span> <div class="slider-row"><button class="reset-btn" data-target="gravidade">R</button><input id="in-grav" type="range" min="-5" max="5" step="0.1" value="2"></div></div>
                <div class="input-container">Wind: <span id="val-wind"></span> <div class="slider-row"><button class="reset-btn" data-target="vento">R</button><input id="in-wind" type="range" min="-5" max="5" step="0.1" value="0"></div></div>
                <div class="input-container">Bounce: <span id="val-bounce"></span> <div class="slider-row"><button class="reset-btn" data-target="elasticidade">R</button><input id="in-bounce" type="range" min="0" max="1.5" step="0.1" value="0.9"></div></div>
                <div class="divider"></div>
                <div class="color-grid" id="global-colors"></div>
                <button id="rand-color-global" class="action-btn">Randomize Colors</button>
                <div class="divider"></div>
                <label><input type="checkbox" id="chk-rainbow"> Rainbows</label><br>
                <label><input type="checkbox" id="chk-trails"> Trails</label><br>
                <button id="reset-all-btn" class="action-btn" style="background:#2196F3">Reset All</button>
                <button id="lemon-global-btn" class="action-btn warning-btn">ALL LEMONS</button>
            </div>
            <div id="content-single" class="tab-content">
                <div id="single-msg" style="text-align:center;opacity:0.6">Select a ball</div>
                <div id="single-controls" style="display:none">
                     <div class="input-container">Size: <div class="slider-row"><input id="s-size" type="range" min="10" max="200"></div></div>
                     <div class="color-grid" id="single-colors"></div>
                     <label><input type="checkbox" id="s-rainbow"> Rainbow</label>
                     <button id="s-delete" class="action-btn danger-btn">Delete</button>
                     <button id="s-lemon" class="action-btn warning-btn">Make Lemon</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// --- CORE VARIABLES ---
var balls = [];
var particles = [];
var trails3D = [];
var settings = { gravidade: 2, vento: 0, tamanho: 100, elasticidade: 0.9, restitution: 0.9 };
const defaultSettings = { ...settings };
var darkModeState = 0; // 0:Light, 1:Dark, 2:Glow
var threeDMode = 0; // 0:Off, 1:Blue, 2:Red
var isPaused = false;
var isNoWalls = false;
var selectedBall = null;
var draggedBall = null;
var soundEnabled = true;
var useLemonSounds = true;

// --- COLORS ---
const COLORS = ["#FF0000", "#FFA500", "#FFFF00", "#00FF00", "#0000FF", "#4B0082", "#EE82EE", "#00FFFF", "#FF00FF", "#FFFFFF", "#000000"];

// --- HELPERS ---
function random(min, max) { return Math.random() * (max - min) + min; }
function randColor() { return COLORS[Math.floor(Math.random() * COLORS.length)]; }
function getLuminance(r,g,b) { return 0.2126*(r/255) + 0.7152*(g/255) + 0.0722*(b/255); }
function getHexRgb(hex) {
    var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return result ? { r: parseInt(result[1], 16), g: parseInt(result[2], 16), b: parseInt(result[3], 16) } : {r:255,g:255,b:255};
}
function parseRgb(str) {
    const m = str.match(/\d+/g);
    return m ? {r:parseInt(m[0]), g:parseInt(m[1]), b:parseInt(m[2])} : {r:0,g:0,b:0};
}

// --- PHYSICS ENGINE ---
function createBall() {
    const div = document.createElement('div'); div.className = 'ball';
    const inner = document.createElement('div'); inner.className = 'ball-inner';
    inner.style.backgroundColor = randColor();
    div.appendChild(inner);
    document.getElementById('world').appendChild(div);
    
    const b = {
        elm: div, innerElm: inner,
        x: window.innerWidth/2, y: window.innerHeight/2,
        vx: random(-10,10), vy: random(-10,10),
        tamanho: settings.tamanho,
        isLemon: false, isRainbow: false,
        ghosts: [], highlight: null
    };
    
    // Add Interaction
    div.onmousedown = (e) => { e.preventDefault(); draggedBall = b; b.lastX=b.x; b.lastY=b.y; selectedBall = b; updateEditor(); };
    div.ontouchstart = (e) => { e.preventDefault(); draggedBall = b; b.lastX=b.x; b.lastY=b.y; selectedBall = b; updateEditor(); };
    
    balls.push(b);
}

function updatePhysics() {
    const w = window.innerWidth; const h = window.innerHeight;
    
    balls.forEach(b => {
        if(b === draggedBall) return;
        const grav = b.isLemon ? defaultSettings.gravidade : (b.gravidade ?? settings.gravidade);
        const wind = b.vento ?? settings.vento;
        b.vx *= 0.995; b.vy *= 0.995;
        b.vy -= grav * 0.1; b.vx += wind * 0.1;
        b.x += b.vx; b.y += b.vy;
        
        const size = b.tamanho ?? settings.tamanho;
        const r = size/2;
        const elas = b.isLemon ? 0.5 : (b.elasticidade ?? settings.elasticidade);
        
        if(isNoWalls) {
            if(b.x > w + r) b.x = -r; if(b.x < -r) b.x = w + r;
            if(b.y > h + r) b.y = -r; if(b.y < -r) b.y = h + r;
        } else {
            if(b.x > w - r) { b.x = w - r; b.vx *= -elas; }
            if(b.x < r) { b.x = r; b.vx *= -elas; }
            if(b.y > h - r) { b.y = h - r; b.vy *= -elas; }
            if(b.y < r) { b.y = r; b.vy *= -elas; }
        }
    });
    
    for(let i=0; i<balls.length; i++) {
        for(let j=i+1; j<balls.length; j++) {
            const b1 = balls[i]; const b2 = balls[j];
            const r1 = (b1.tamanho??settings.tamanho)/2; 
            const r2 = (b2.tamanho??settings.tamanho)/2;
            const dx = b2.x - b1.x; const dy = b2.y - b1.y;
            const dist = Math.sqrt(dx*dx + dy*dy);
            const minDist = r1 + r2;
            
            if(dist < minDist && dist > 0) {
                const nx = dx/dist; const ny = dy/dist;
                const tx = -ny; const ty = nx;
                const dpTan1 = b1.vx * tx + b1.vy * ty; const dpTan2 = b2.vx * tx + b2.vy * ty;
                const dpNorm1 = b1.vx * nx + b1.vy * ny; const dpNorm2 = b2.vx * nx + b2.vy * ny;
                const m1 = r1; const m2 = r2; const M = m1 + m2;
                const v1n = (dpNorm1 * (m1 - m2) + 2 * m2 * dpNorm2) / M;
                const v2n = (dpNorm2 * (m2 - m1) + 2 * m1 * dpNorm1) / M;
                const rest = ((b1.restitution??settings.restitution) + (b2.restitution??settings.restitution)) / 2;
                
                b1.vx = tx * dpTan1 + nx * v1n * rest; b1.vy = ty * dpTan1 + ny * v1n * rest;
                b2.vx = tx * dpTan2 + nx * v2n * rest; b2.vy = ty * dpTan2 + ny * v2n * rest;
                const overlap = (minDist - dist) / 2;
                b1.x -= overlap * nx; b1.y -= overlap * ny;
                b2.x += overlap * nx; b2.y += overlap * ny;
            }
        }
    }
}

// --- 3D ENGINE ---
var threeEngine = {
    loaded: false,
    init: function() {
        if(!window.THREE || !window.THREE.EffectComposer || !window.THREE.UnrealBloomPass) return false;
        
        this.scene = new THREE.Scene();
        this.camera = new THREE.PerspectiveCamera(40, window.innerWidth/window.innerHeight, 10, 5000);
        this.renderer = new THREE.WebGLRenderer({ antialias: true });
        this.renderer.setSize(window.innerWidth, window.innerHeight);
        this.renderer.shadowMap.enabled = true;
        this.renderer.toneMapping = THREE.ReinhardToneMapping;
        this.renderer.toneMappingExposure = 1.3;
        document.getElementById('three-container').appendChild(this.renderer.domElement);
        
        // BLOOM: Threshold 0 to make colors glow
        this.composer = new THREE.EffectComposer(this.renderer);
        this.composer.addPass(new THREE.RenderPass(this.scene, this.camera));
        this.bloom = new THREE.UnrealBloomPass(new THREE.Vector2(window.innerWidth,window.innerHeight), 2.5, 0.5, 0.0);
        this.composer.addPass(this.bloom);
        
        // Env
        this.floor = new THREE.Mesh(new THREE.PlaneGeometry(10000,5000), new THREE.MeshStandardMaterial({ color: 0xcccccc, roughness: 0.8 }));
        this.floor.rotation.x = -Math.PI/2;
        this.floor.receiveShadow = true;
        this.scene.add(this.floor);
        this.backWall = new THREE.Mesh(new THREE.PlaneGeometry(10000,5000), new THREE.MeshStandardMaterial({ color: 0xdddddd }));
        this.backWall.position.z = -1000;
        this.scene.add(this.backWall);
        
        // Lights
        this.amb = new THREE.AmbientLight(0xffffff, 0.5);
        this.scene.add(this.amb);
        this.sun = new THREE.DirectionalLight(0xffffff, 0.7);
        this.sun.position.set(-200, 1000, 500);
        this.sun.castShadow = true;
        this.sun.shadow.mapSize.width = 2048; this.sun.shadow.mapSize.height = 2048;
        this.sun.shadow.camera.left = -2000; this.sun.shadow.camera.right = 2000;
        this.sun.shadow.camera.top = 2000; this.sun.shadow.camera.bottom = -2000;
        this.scene.add(this.sun);
        
        this.meshes = new Map();
        this.lemonGeo = new THREE.SphereGeometry(1,32,32);
        this.lemonGeo.scale(1.6, 1, 1); 
        this.loaded = true;
        return true;
    },
    
    render: function() {
        if(!this.loaded) { if(!this.init()) return; }
        
        const w = window.innerWidth; const h = window.innerHeight;
        const zDist = (h/2) / Math.tan(THREE.Math.degToRad(20));
        this.camera.position.set(0, 0, zDist);
        this.floor.position.y = -h/2;
        
        const isRed = threeDMode === 2;
        const isGlow = darkModeState === 2;
        
        let bg = (darkModeState > 0) ? 0x1a1a1a : 0xf0f0f0;
        this.scene.background = new THREE.Color(bg);
        this.scene.fog = new THREE.Fog(bg, zDist, zDist*3);
        this.floor.material.color.setHex(darkModeState > 0 ? 0x333333 : 0xcccccc);
        this.backWall.material.color.setHex(darkModeState > 0 ? 0x444444 : 0xdddddd);
        this.floor.visible = !isNoWalls; this.backWall.visible = !isNoWalls;
        
        this.meshes.forEach(v => v.seen = false);
        
        balls.forEach(b => {
            let obj = this.meshes.get(b);
            if(!obj) {
                const mat = new THREE.MeshStandardMaterial({ roughness: 0.4 });
                const mesh = new THREE.Mesh(this.lemonGeo, mat); // Shared geo for now, scale later
                mesh.castShadow = true;
                this.scene.add(mesh);
                obj = { mesh, seen: true };
                this.meshes.set(b, obj);
            }
            obj.seen = true;
            const mesh = obj.mesh;
            
            const r = (b.tamanho??settings.tamanho)/2;
            
            // Position
            mesh.position.set(b.x - w/2, (b.y - h/2) + (b.isLemon ? -r*0.2 : 0), 0);
            
            // Rotation/Scale
            if(b.isLemon) {
                mesh.scale.set(r*1.6, r, r);
                mesh.rotation.set(0, 0, -b.x * 0.01);
                mesh.material.color.setHex(0xFFFF00);
            } else {
                mesh.scale.setScalar(r);
                mesh.rotation.set(0,0,0);
                mesh.material.color.setStyle(b.innerElm.style.backgroundColor);
            }
            
            // GLOW LOGIC
            const col = mesh.material.color;
            // Simple check: Is it black?
            const isBlack = (col.r < 0.1 && col.g < 0.1 && col.b < 0.1);
            
            if(isGlow && !isBlack) {
                mesh.material.emissive.copy(col);
                mesh.material.emissiveIntensity = 2.5; // Max glow
                mesh.material.roughness = 0.1;
            } else {
                mesh.material.emissive.setHex(0x000000);
                mesh.material.emissiveIntensity = 0;
                mesh.material.roughness = 0.4;
            }
            
            // Shadows
            mesh.receiveShadow = isRed; // Blue = False, Red = True
        });
        
        for(const [k,v] of this.meshes) { if(!v.seen) { this.scene.remove(v.mesh); this.meshes.delete(k); } }
        this.composer.render();
    }
};

// --- MAIN LOOP ---
function loop() {
    if(!isPaused) updatePhysics();
    
    if(threeDMode > 0) {
        document.body.classList.add('mode-3d');
        document.body.classList.remove('mode-2d');
        document.getElementById('three-container').style.display = 'block';
        threeEngine.render();
    } else {
        document.body.classList.remove('mode-3d');
        document.body.classList.add('mode-2d');
        document.getElementById('three-container').style.display = 'none';
        render2D();
    }
    requestAnimationFrame(loop);
}

function render2D() {
    balls.forEach(b => {
        b.elm.style.display = 'block';
        const size = b.tamanho ?? settings.tamanho;
        b.elm.style.width = size + 'px'; b.elm.style.height = size + 'px';
        b.elm.style.left = (b.x - size/2) + 'px';
        b.elm.style.top = (window.innerHeight - b.y - size/2) + 'px';
        b.innerElm.style.backgroundColor = b.innerElm.style.backgroundColor; // refresh
        
        if(b.isRainbow) {
            b.hue = (b.hue ? b.hue+1 : 0) % 360;
            b.innerElm.style.backgroundColor = `hsl(${b.hue}, 100%, 50%)`;
        }
        
        // 2D GLOW
        if(darkModeState === 2 && !b.isLemon) {
             const col = b.innerElm.style.backgroundColor;
             const rgb = col.startsWith('#') ? getHexRgb(col) : parseRgb(col);
             // Check black
             if(rgb.r < 30 && rgb.g < 30 && rgb.b < 30) {
                 b.elm.style.boxShadow = 'none';
             } else {
                 // Force bright shadow
                 const r = Math.min(255, rgb.r+60); const g = Math.min(255, rgb.g+60); const bval = Math.min(255, rgb.b+60);
                 b.elm.style.boxShadow = `0 0 20px 5px rgba(${r},${g},${bval},0.9), 0 0 50px 15px rgba(${r},${g},${bval},0.5)`;
             }
        } else {
            b.elm.style.boxShadow = 'none';
        }
        
        if(b.isLemon) {
            b.innerElm.style.borderRadius = '50% 0';
            b.elm.style.transform = `rotate(${b.x * -0.5}deg)`;
            b.innerElm.style.backgroundColor = '#FFFF00';
        } else {
            b.innerElm.style.borderRadius = '50%';
            b.elm.style.transform = 'none';
        }
        
        if(b === selectedBall) {
            if(!b.highlight) { b.highlight = document.createElement('div'); b.highlight.className = 'highlight-box'; document.getElementById('world').appendChild(b.highlight); }
            b.highlight.style.display = 'block';
            b.highlight.style.width = (size+10)+'px'; b.highlight.style.height = (size+10)+'px';
            b.highlight.style.left = (b.x - size/2 - 5)+'px'; b.highlight.style.top = (window.innerHeight - b.y - size/2 - 5)+'px';
        } else if(b.highlight) b.highlight.style.display = 'none';
    });
}

// --- INPUTS ---
window.onmousemove = (e) => { if(draggedBall) { draggedBall.x = e.clientX; draggedBall.y = window.innerHeight - e.clientY; draggedBall.vx=0; draggedBall.vy=0; } };
window.onmouseup = () => { draggedBall = null; };
window.ontouchmove = (e) => { if(draggedBall) { draggedBall.x = e.touches[0].clientX; draggedBall.y = window.innerHeight - e.touches[0].clientY; } };
window.ontouchend = () => { draggedBall = null; };

// --- UI ---
document.getElementById('add-btn').onclick = createBall;
document.getElementById('clear-btn').onclick = () => balls = [];
document.getElementById('threed-btn').onclick = () => { 
    threeDMode = (threeDMode + 1) % 3; 
    const btn = document.getElementById('threed-btn');
    btn.className = threeDMode === 1 ? 'active' : (threeDMode === 2 ? 'red-active' : '');
};
document.getElementById('dark-mode-btn').onclick = () => {
    darkModeState = (darkModeState + 1) % 3;
    document.body.className = darkModeState === 0 ? '' : (darkModeState === 1 ? 'dark-mode' : 'dark-mode glow-mode');
};
document.getElementById('editor-btn').onclick = () => { document.getElementById('side-box').classList.add('hidden'); document.getElementById('editor-box').classList.remove('hidden'); document.body.classList.add('editor-active'); };
document.getElementById('done-btn').onclick = closeEditor;
document.getElementById('no-walls-btn').onclick = () => { isNoWalls = !isNoWalls; document.getElementById('no-walls-btn').classList.toggle('active'); };
document.getElementById('pause-btn').onclick = () => { isPaused = !isPaused; };

function updateEditor() {
    if(selectedBall) {
        document.getElementById('tab-single').click();
        document.getElementById('s-size').value = selectedBall.tamanho ?? settings.tamanho;
        document.getElementById('s-rainbow').checked = selectedBall.isRainbow;
    }
}

// Global Sliders
document.getElementById('in-size').oninput = (e) => settings.tamanho = parseFloat(e.target.value);
document.getElementById('in-grav').oninput = (e) => settings.gravidade = parseFloat(e.target.value);
document.getElementById('in-wind').oninput = (e) => settings.vento = parseFloat(e.target.value);
document.getElementById('in-bounce').oninput = (e) => settings.elasticidade = parseFloat(e.target.value);
document.getElementById('rand-color-global').onclick = () => balls.forEach(b => b.innerElm.style.backgroundColor = randColor());
document.getElementById('reset-all-btn').onclick = () => { balls = []; settings = {...defaultSettings}; threeDMode = 0; darkModeState = 0; document.body.className = ''; };
document.getElementById('lemon-global-btn').onclick = () => balls.forEach(b => { b.isLemon = true; b.innerElm.style.backgroundColor = 'yellow'; });
document.getElementById('tab-global').onclick = () => { document.getElementById('tab-global').classList.add('active'); document.getElementById('tab-single').classList.remove('active'); document.getElementById('content-global').style.display='block'; document.getElementById('content-single').style.display='none'; };
document.getElementById('tab-single').onclick = () => { document.getElementById('tab-single').classList.add('active'); document.getElementById('tab-global').classList.remove('active'); document.getElementById('content-single').style.display='block'; document.getElementById('content-global').style.display='none'; };
document.getElementById('s-size').oninput = (e) => { if(selectedBall) selectedBall.tamanho = parseFloat(e.target.value); };
document.getElementById('s-rainbow').onchange = (e) => { if(selectedBall) selectedBall.isRainbow = e.target.checked; };
document.getElementById('s-delete').onclick = () => { if(selectedBall) { balls = balls.filter(b => b !== selectedBall); selectedBall = null; closeEditor(); }};
document.getElementById('s-lemon').onclick = () => { if(selectedBall) { selectedBall.isLemon = true; selectedBall.innerElm.style.backgroundColor = 'yellow'; }};

for(let i=0; i<3; i++) createBall();
loop();
</script>
</body>
</html>


